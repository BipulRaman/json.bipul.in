name: Build and Deploy
on:  
  workflow_dispatch:  
  
permissions:
  contents: write
jobs:
  build-and-deploy:
    concurrency: ci-${{ github.ref }} # Recommended if you intend to make multiple deployments in quick succession.
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3		
      - name: Fetch GSheetCSV 📦
        uses: JamesIves/fetch-api-data-action@v2
        with:
          endpoint: https://docs.google.com/spreadsheets/d/e/2PACX-1vRsOKxvAtXmqonNAKffKOeJYvQ2vYzssJ3ZxMeiJdwjQjLiNQQgy5BViFsMGOnUKI-PnCJ3XmNcn1Jd/pub?output=csv
          configuration: '{ "method": "GET"}'
          save-location: dist
          save-name: mycsv
          format: csv

      - name: Convert CSV to JSON and delete CSV
        run: |
          for csv_file in *.csv; do
            if [ -f "$csv_file" ]; then
              json_file="${csv_file%.csv}.json"
              # Convert CSV to JSON
              jq -Rsn '
                [inputs | split("\n") | .[] | select(length > 0)] as $lines |
                ($lines[0] | split(",")) as $headers |
                [$lines[1:][] | split(",") | 
                  reduce range(0; $headers | length) as $i
                  ({}; . + {($headers[$i]): .[$i]})
                ]
              ' < "$csv_file" > "$json_file"
              echo "Converted $csv_file to $json_file"
              # Delete the CSV file
              rm "$csv_file"
              echo "Deleted $csv_file"
            fi
          done
        
      - name: Deploy 🚀
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
